## [2025-01-03] - Изменение логики синхронизации заказов

### Добавлено
- **НОВЫЙ МЕТОД**: `_get_order_details_from_api()` в OrderSyncService для получения полных деталей заказа
- **НОВЫЙ МЕТОД**: `_check_order_needs_update()` для оптимизированной проверки необходимости обновления заказов
- Поддержка нового источника данных "full_api_details" в `_process_single_order_safe()`
- Логика получения revision из корня заказа для полных деталей API
- Fallback логика для генерации revision при её отсутствии в событии

### Изменено
- **КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ**: Оптимизированный принцип работы синхронизации событий:
  1. Сохранение каждого события в базу данных (всегда)
  2. Проверка существования заказа в БД по order_id + token_id
  3. Сравнение revision из checkoutForm события с revision в БД
  4. Получение полных деталей заказа через API только при необходимости
  5. Создание/обновление заказа только если revision отличается или заказа нет
- **ИСПРАВЛЕНА ДЕДУПЛИКАЦИЯ**: DeduplicationService.should_process_order теперь всегда разрешает обработку заказов, так как решение принимается на уровне revision
- **УПРОЩЕН КОД**: Метод _fetch_order_events_safe значительно упрощен - убрана избыточная логика обработки событий, которая дублировалась в sync_orders_safe
- **ОБНОВЛЕН МОНИТОРИНГ**: DataMonitoringService теперь поддерживает новый источник данных "full_api_details" - обновлены методы валидации структуры и качества данных
- Значительно снижена нагрузка на Allegro API - запросы только при реальной необходимости
- Улучшена обработка источников данных в `_process_single_order_safe()`
- Логика теперь получает актуальные данные напрямую от Allegro только когда это нужно

### Исправлено
- **КРИТИЧЕСКАЯ ОШИБКА**: Удален дублирующий код обработки событий - была двойная логика (старая + новая)
- **КРИТИЧЕСКАЯ ОШИБКА**: Исправлена ошибка NameError в _process_single_order_safe - переменная revision не была определена для источников full_api_details и checkout_forms_api
- Устранена некорректная блокировка существующих заказов в DeduplicationService
- Устранены избыточные запросы к API для заказов с неизменной revision
- Оптимизирована производительность синхронизации событий
- Улучшена обработка случаев отсутствия revision в событиях

### Результат
- **ПРОИЗВОДИТЕЛЬНОСТЬ**: Кратное снижение количества API запросов к Allegro
- **НАДЕЖНОСТЬ**: События всегда сохраняются независимо от состояния API
- **АКТУАЛЬНОСТЬ**: Заказы обновляются только при реальных изменениях
- **ЭФФЕКТИВНОСТЬ**: Система работает с минимальной нагрузкой на внешние API
- **КОРРЕКТНОСТЬ**: Устранена логическая ошибка дублирования кода и блокировки обновлений

### ~~Планируется~~
- ~~Тестирование новой логики синхронизации~~
- ~~Улучшение обработки ошибок для недоступности API~~
- ~~Полная документация изменений~~

### ~~В процессе~~
- ~~**НОВАЯ ЛОГИКА**: Переход на получение полных деталей заказов через API для каждого события~~
- ~~Изменение принципа работы: событие → получение деталей по API → создание/обновление заказа~~
- ~~Отказ от использования данных заказа из структуры событий в пользу прямых API запросов~~
- ~~Обеспечение получения всегда актуальных и полных данных заказов~~

### ~~Планируется~~
- ~~Создание метода получения деталей заказа в OrderSyncService~~
- ~~Модификация логики обработки событий в _process_orders_batch~~
- ~~Обновление обработки ошибок для недоступности API~~

# Changelog

## [2025-07-30] - Исправление валидации данных для Events API

### Исправлено
- **КРИТИЧЕСКАЯ ОШИБКА**: Исправлена валидация обязательных полей в OrderProtectionService для работы с Events API
- Устранена ошибка "❌ Отсутствуют обязательные поля для создания: ['id']" при обработке событий
- Исправлена несовместимость структуры данных: Events API возвращает ID в checkoutForm.id, а не в корневом поле id
- Добавлена поддержка разных структур данных от разных API Allegro (Events API vs Checkout Forms API)

### Изменено
- Переписана логика валидации обязательных полей с учетом реальной структуры данных от Allegro
- Добавлены методы `_get_required_fields_for_structure()` и `_has_required_field()` для умной валидации
- Система теперь автоматически определяет тип структуры данных и применяет соответствующую валидацию
- Улучшено логирование ошибок валидации с указанием типа структуры данных

### Добавлено
- Поддержка структуры данных Events API: `{checkoutForm: {id, revision}, buyer, lineItems, ...}`
- Поддержка структуры данных Checkout Forms API: `{id, status, buyer, lineItems, ...}`
- Адаптивная валидация в зависимости от источника данных
- Детальная диагностика структуры данных при ошибках

## [2025-07-30] - Исправление ошибки дублирования task_id в TaskHistory

### Исправлено
- Исправлена критическая ошибка "duplicate key value violates unique constraint ix_task_history_task_id"
- Добавлена логика upsert в TaskHistoryService.create_task() для предотвращения дублирования записей
- Исправлена проблема с повторными запусками задач Celery (retry, beat scheduler)
- Добавлена дополнительная обработка ошибок базы данных с rollback

### Изменено
- Метод create_task() теперь проверяет существование задачи перед созданием
- При обнаружении существующей задачи обновляет её вместо создания новой
- Улучшена обработка race conditions при параллельных запусках задач
- Добавлено детальное логирование операций с задачами

### Добавлено
- Логика upsert (update or insert) для безопасного создания задач
- Защита от параллельных создания одинаковых задач
- Дополнительная попытка поиска задачи при ошибках базы данных

## [2025-07-30] - Устранение дублирования событий заказов

### Исправлено
- Убрано дублирующее сохранение события "ORDER_SYNC" в OrderProtectionService
- Убрано дублирующее сохранение событий в _process_single_order_safe()

### Изменено
- События теперь сохраняются только один раз - в родительском методе sync_orders_safe
- OrderProtectionService больше не создает техническое событие "ORDER_SYNC"
- _process_single_order_safe теперь отвечает только за обработку заказа
- Оставлены только события восстановления ("ORDER_RESTORED") и снимки данных ("DATA_SNAPSHOT")

## [2025-07-30] - Критическая оптимизация обработки событий заказов

### Исправлено
- Исправлена ошибка сохранения стартовой точки событий с order_id=None
- Использование специального значения "SYNC_STARTING_POINT" вместо NULL для order_id
- Исправлен парсинг даты occurredAt из строки в объект datetime при получении статистики событий

### Изменено
- **КРИТИЧЕСКАЯ ОПТИМИЗАЦИЯ**: Убраны лишние запросы к Checkout Forms API при обработке событий
- Events API уже содержит полные данные заказа в поле order - дополнительные запросы не нужны
- Улучшена производительность синхронизации: вместо N+1 запросов теперь только 1 запрос
- Упрощена логика извлечения order_id: используется только checkoutForm.id
- Обновлены комментарии в коде для отражения новой логики

### Удалено
- Удален неиспользуемый метод `_fetch_order_details_safe()`
- Убрана сложная логика поиска order_id в различных местах события

## [2025-07-30] - Исправление системы анализа аномалий данных

### Исправлено
- Исправлена некорректная валидация структуры данных в DataMonitoringService для checkout_forms_api
- Исправлена опечатка в поле `fullfillment` → `fulfillment` при проверке структуры заказов
- Исправлена логика извлечения order_id из разных источников данных (events_api vs checkout_forms_api)
- Исправлена проблема с возвратом пустого словаря вместо None при отсутствии order_id

### Изменено
- Улучшена валидация качества данных заказов с детальным логированием отсутствующих полей
- DEBUG логи заменены на более информативные сообщения для диагностики
- Удален избыточный отладочный вывод полных данных заказов из логов
- Разделена логика валидации для events_api и checkout_forms_api

### Добавлено
- Детальное логирование процесса валидации структуры данных
- Проверка наличия lineItems в валидации качества данных заказов
- Специфичная обработка разных форматов данных от Allegro API

## [2025-07-30] - Автоматическое удаление периодических задач при удалении токена

### Добавлено
- Автоматическое удаление всех связанных с токеном периодических задач синхронизации при его удалении
- Новый приватный метод `_remove_periodic_sync_tasks()` в TokenService
- Интеграция с ActiveSyncScheduleService и PeriodicTaskService для полной очистки
- Детальное логирование процесса удаления задач с обработкой ошибок

### Изменено
- Метод `TokenService.deactivate_token()` теперь удаляет связанные периодические задачи
- Улучшена надежность процесса удаления токенов за счет каскадного удаления задач
- Добавлены дополнительные импорты для работы с сервисами периодических задач

### Исправлено
- Исправлена проблема "висящих" периодических задач после удаления токенов
- Предотвращена ситуация когда Celery Beat пытается выполнить задачи для несуществующих токенов

## [2025-07-30] - Расширение детализации логирования для диагностики

### Изменено
- Уровень логирования по умолчанию изменен с INFO на DEBUG
- Критически важные DEBUG логи заменены на INFO в ключевых сервисах
- Улучшена детализация логирования процессов обработки заказов
- Расширено логирование в OrderSyncService для полного трекинга синхронизации
- Улучшено логирование в OrderProtectionService для диагностики валидации данных
- Обновлено логирование в OrderService для трекинга запросов к API

### Добавлено
- Детальное логирование источника данных (checkout_forms_api vs events_api)
- Логирование всех этапов обработки заказов с указанием причин отклонения
- Расширенная диагностика процессов дедупликации и валидации
- Полное отслеживание метрик качества данных и аномалий

## [2025-07-30] - Полное отключение технических логов от внешних библиотек

### Исправлено
- Полностью отключены все технические логи от внешних библиотек
- Создана функция `disable_technical_logging()` для централизованного управления
- Отключены логи от httpcore, httpx, urllib3, requests, redis, asyncio и других
- Убраны DEBUG логи HTTP соединений и запросов

### Изменено
- Функция `disable_sqlalchemy_logging()` переименована в `disable_technical_logging()`
- Расширен список отключаемых логгеров (35+ технических компонентов)
- Технические логи отключаются в самом начале инициализации приложения
- Оставлены только содержательные логи от основных компонентов приложения

### Добавлено
- Отключение логов от HTTP клиентов (httpcore, httpx, urllib3, requests)
- Отключение технических логов Celery (worker.strategy, consumer, heartbeat)
- Отключение логов Redis, Asyncio, Alembic и других библиотек
- Централизованное управление техническими логами

## [2025-07-30] - Дополнительное исправление логирования SQLAlchemy

### Исправлено
- Полностью отключены логи SQLAlchemy (уровень CRITICAL)
- Исправлен порядок инициализации логирования в main.py
- Добавлены дополнительные настройки для всех SQLAlchemy логгеров
- Логирование теперь инициализируется до создания первого логгера

### Изменено
- SQLAlchemy логи теперь полностью скрыты (вместо ERROR уровня)
- Улучшена последовательность инициализации компонентов

## [2025-07-30] - Исправление ошибки сериализации UUID в TaskHistoryService

### Исправлено
- Критическая ошибка сериализации UUID в TaskHistoryService.update_task()
- Добавлена поддержка UUID в default_serializer для JSON сериализации
- Исправлены типы user_id с UUID на str во всех методах TaskHistoryService
- Убран неиспользуемый импорт UUID

### Изменено
- TaskHistoryService теперь корректно обрабатывает UUID объекты в результатах задач
- Все методы используют str для user_id вместо UUID

## [2025-07-30] - Улучшение системы логирования

### Добавлено
- Новый форматировщик `HumanReadableFormatter` для удобочитаемых логов
- Эмодзи-индикаторы для разных уровней логирования (🚨❌⚠️ℹ️🔍)
- Структурированный вывод с дополнительной информацией (user_id, task_id, request_id)
- Автоматическое определение модуля в логах

### Изменено
- По умолчанию используется формат "human" вместо "json"
- Уровни логирования SQLAlchemy изменены на ERROR для устранения шума
- Уровни логирования Celery оптимизированы для показа только важных сообщений
- Добавлены настройки уровней для всех внешних библиотек (httpx, redis, alembic, etc.)

### Исправлено
- Устранен избыточный вывод SQL запросов в логах
- Улучшена читаемость логов в консоли и файлах
- Оптимизированы уровни логирования для production среды

## [2025-07-29] - Исправление ошибок сериализации

### Исправлено
- Ошибка сериализации UUID в TaskHistoryService
- Проблемы с обновлением задач в Celery
- Улучшена обработка ошибок в системе мониторинга данных

## [2025-07-28] - Реализация системы защиты данных

### Добавлено
- OrderProtectionService для защиты целостности данных
- DataMonitoringService для мониторинга качества данных
- Система детекции аномалий в данных заказов
- Автоматическая пауза синхронизации при критических проблемах

### Изменено
- Интеграция системы защиты в OrderSyncService
- Улучшена обработка ошибок и исключений
- Добавлены метрики здоровья данных

## [2025-07-27] - Система дедупликации событий

### Добавлено
- DeduplicationService для предотвращения дублирования событий
- Система отслеживания уникальных event_id от Allegro
- Автоматическая очистка дублированных записей

### Изменено
- Интеграция дедупликации в процесс синхронизации
- Улучшена производительность обработки событий

## [2025-07-26] - JWT аутентификация

### Добавлено
- JWT токены для аутентификации API
- Middleware для проверки токенов
- Система управления пользователями

### Изменено
- Обновлены API endpoints для поддержки JWT
- Добавлена защита маршрутов

## [2025-07-25] - Device Code Flow авторизация

### Добавлено
- AllegroAuthService для работы с OAuth 2.0 Device Code Flow
- Автоматическое обновление токенов
- Система управления токенами пользователей

### Изменено
- Интеграция авторизации в основной процесс
- Улучшена безопасность работы с токенами

## [2025-07-24] - Базовая архитектура

### Добавлено
- FastAPI приложение с SQLModel и PostgreSQL
- Celery для фоновых задач
- Redis для кэширования и очередей
- Docker контейнеризация
- Alembic для миграций базы данных

### Изменено
- Настроена базовая структура проекта
- Реализованы основные модели данных 

### Исправлено
- **КРИТИЧЕСКИЕ ОШИБКИ ВЫЯВЛЕНИЯ ДАННЫХ**: Исправлены ложные аномалии в DataMonitoringService из-за неправильной валидации событий Events API:
  - События из Events API теперь корректно валидируются с учетом их структуры (checkoutForm.id вместо прямого id)
  - Убраны ложные срабатывания "100% событий имеют неполные данные" и "серьезные проблемы данных"
  - Добавлено подробное логирование для отладки проблем валидации данных
  - Events API и Checkout Forms API теперь валидируются по разным правилам соответствующим их структуре
- **ЛОЖНЫЕ АНОМАЛИИ "ДУБЛИКАТОВ"**: Исправлена неправильная детекция дубликатов для Events API:
  - Для Events API дубликаты теперь проверяются по event_id (а не order_id)
  - Множественные события для одного заказа (BOUGHT → FILLED_IN → READY_FOR_PROCESSING) теперь НЕ считаются дубликатами
  - Для Checkout Forms API дубликаты по-прежнему проверяются по order_id (где это действительно означает дубликат)
- **ЛОЖНЫЕ АНОМАЛИИ "РАЗНООБРАЗИЯ"**: Убрана проверка "низкого разнообразия заказов" для Events API:
  - Для Events API нормально иметь много событий на один заказ - это жизненный цикл заказа
  - Проверка разнообразия теперь применяется только к Checkout Forms API
- Исправлена обработка источника данных "full_api_details" в валидации структуры событий 