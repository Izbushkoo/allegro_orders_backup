# Changelog - Allegro Orders Backup

Все важные изменения в проекте документируются в этом файле.

## [Unreleased]

### Добавлено
- **Реализация Device Code Flow авторизации**: Добавлены эндпоинты для полного цикла авторизации через Allegro API
  - `POST /auth/initialize` - инициализация процесса авторизации с автоматическим polling
  - `GET /auth/status/{device_code}` - проверка статуса авторизации (ручная)
  - `GET /auth/task/{task_id}` - отслеживание прогресса автоматической авторизации
  - `POST /{token_id}/validate` - проверка и автоматическое обновление токенов
- **Автоматический polling авторизации**: Celery задача автоматически отслеживает процесс авторизации и сохраняет токен по завершении
- **Сервис AllegroAuthService**: Полная реализация работы с Allegro API для авторизации и управления токенами
- **Интеграция с Allegro API**: Реальная работа с официальным API Allegro через aiohttp
- **Автоматическое управление токенами**: Проверка срока действия и автоматическое обновление через refresh_token
- **Диаграмма Device Code Flow**: Добавлена подробная Mermaid диаграмма в документацию проекта, показывающая полный процесс авторизации с автоматическим polling
- **Реализация API эндпоинтов для токенов**: Созданы рабочие эндпоинты для CRUD операций с токенами
- **Сервисы для работы с базой данных**: Создан TokenService для бизнес-логики работы с токенами
- **Обработка ошибок**: Добавлены кастомные исключения и их обработка в API
- **Зависимости FastAPI**: Настроены dependencies для работы с базой данных
- **Swagger UI документация**: Настроена полная документация API с интерактивными эндпоинтами
- **API структура v1**: Созданы роутеры для всех основных операций:
  - `/api/v1/tokens/` - управление токенами Allegro (создание, обновление, удаление)
  - `/api/v1/orders/` - операции с заказами (просмотр, статистика, события)
  - `/api/v1/sync/` - синхронизация заказов (запуск, мониторинг, история)
- **Подробная OpenAPI спецификация**: Добавлены детальные описания всех эндпоинтов, параметров и моделей данных
- **Pydantic модели**: Созданы модели для всех API запросов и ответов с валидацией
- **Теги и группировка**: API эндпоинты логично сгруппированы по функциональности
- **Улучшенная документация**: Добавлены подробные описания, примеры использования и контактная информация
- .dockerignore файл для оптимизации Docker контекста сборки
- Зависимость `asyncpg` для асинхронного подключения к PostgreSQL
- .env.example файл с полной конфигурацией переменных окружения
- Подробное логирование настроек приложения при запуске
- Маскирование чувствительных данных в логах (пароли, ключи, токены)
- Endpoint `/config` для просмотра текущей конфигурации (для отладки)
- Анализ переменных окружения: показывает какие загружены из .env, а какие используют значения по умолчанию
- **Система автоматических миграций базы данных**:
  - Скрипт `scripts/create_migration.py` для управления миграциями Alembic
  - Makefile с командами для работы с БД (`make migration`, `make upgrade`, `make init-db`)
  - Документация по работе с миграциями в `docs/migrations.md`
  - Автогенерация миграций на основе изменений в SQLModel моделях

### Изменено
- **Переход с aiohttp на httpx**: Заменили aiohttp на httpx в AllegroAuthService для единообразия HTTP-клиентов в проекте
- **Обновлена документация проекта**: Актуализированы API эндпоинты в project.md, добавлен раздел Device Code Flow с диаграммой, обновлен прогресс этапа 2 до 90%
- Оптимизирован Dockerfile для кеширования зависимостей (разделение слоев установки зависимостей и копирования кода)
- Улучшена производительность Docker сборки за счет правильного кеширования слоев
- Добавлена retry логика для подключения к базе данных с exponential backoff (10 попыток)

### Исправлено
- **Исправлена ошибка с зависимостями FastAPI в tokens.py**: Исправлено неправильное использование `DatabaseSession` в эндпоинте `update_token`, что вызывало ошибку "Invalid args for response field!" при запуске приложения
- **Исправлена ошибка Pydantic в UserToken модели**: Добавлена конфигурация `extra: "ignore"` в BaseModel для решения проблемы `'UserToken' object has no attribute '__pydantic_extra__'`
- **Исправлена сигнатура метода update_token**: Приведены в соответствие параметры метода в TokenService и его использование в других сервисах
- **Исправлено дублирование Celery задач**: Добавлена уникальность задач polling авторизации на основе device_code для предотвращения одновременного выполнения
- **Улучшена обработка retry в Celery**: Добавлена правильная обработка исключений retry и проверка истечения времени авторизации
- **Исправлена ошибка 500 в DELETE токенов**: Заменено прямое изменение полей объекта на SQL UPDATE запрос в методе `deactivate_token` для избежания конфликтов с Pydantic v2
- **Унифицированы datetime операции**: Заменен `datetime.now()` на `datetime.utcnow()` для консистентности временных зон
- **Решена проблема Pydantic v2 в SQLModel**: Переход на SQL UPDATE запросы вместо прямого изменения полей для критически важных операций
- **Приведены к единому стилю API эндпоинты**: Все эндпоинты в `tokens.py` теперь используют единый подход к обработке ошибок и зависимостям
- **Исправлена ошибка импорта в миграции БД**: Исправлен некорректный импорт `sqlmodel.sql.sqltypes` на `sqlmodel` в файле миграции `510553f52617_init.py`, что устранило ошибку `NameError: name 'sqlmodel' is not defined` при применении миграций
- Исправлена проблема с недоступностью команд uvicorn/celery в Docker контейнерах
- Настроен Poetry для установки зависимостей в системное окружение Python (`virtualenvs.create false`)
- Добавлено копирование README.md в Dockerfile для корректной установки проекта через Poetry
- Возвращены прямые команды в docker-compose.yml (без `poetry run`)
- Исправлена ошибка "ModuleNotFoundError: No module named 'asyncpg'" - добавлена недостающая зависимость
- Добавлены значения по умолчанию для всех обязательных настроек (DATABASE_URL, SECRET_KEY, etc.) для работы без .env файла
- Исправлена проблема подключения к базе данных: принудительно установлены `DATABASE_HOST=postgres` и `REDIS_HOST=redis` в docker-compose.yml
- Исправлена ошибка SQLAlchemy: заменен `"SELECT 1"` на `text("SELECT 1")` для совместимости с SQLAlchemy 2.x

## [1.1.0] - 2024-01-15

### Добавлено
- **Базовая инфраструктура проекта (Этап 1)**:
  - pyproject.toml с Poetry конфигурацией и всеми зависимостями
  - docker-compose.yml с полной инфраструктурой (PostgreSQL, Redis, FastAPI, Celery)
  - Dockerfile для Python 3.12 с Poetry
  - .env.example с полной конфигурацией проекта
  - Система настроек через Pydantic Settings с модульной структурой
  - JSON логирование с ротацией файлов и декораторами
  - Модели SQLModel для всех таблиц БД (user_tokens, orders, order_events, sync_history)
  - Alembic конфигурация для миграций базы данных
  - FastAPI приложение с lifespan управлением и health checks
  - Celery приложение с автоматическим расписанием задач
  - Базовые Celery задачи для токенов, синхронизации и очистки
  - README.md с полными инструкциями по запуску и разработке

### Изменено
- Структура проекта полностью создана согласно архитектуре

### Исправлено
- Отсутствует

## [1.0.1] - 2024-01-15

### Добавлено
- **Исследование Allegro API**: Анализ документации по ключевым endpoints
- **Rate Limits**: Детальные лимиты запросов (1000/мин общие, 100/мин заказы, 60/мин события)
- **Структура данных заказов**: Полная схема полей API ответов Allegro
- **Event-driven синхронизация**: Стратегия через GET /order/events для отслеживания изменений
- **Таблица order_events**: Дополнительная таблица БД для хранения событий заказов
- **Индексы БД**: Оптимизированные индексы для производительности запросов
- **Обработка ошибок**: HTTP коды, retry стратегии, exponential backoff

### Изменено
- **qa.md**: Все критические вопросы получили детальные ответы
- **Стратегия синхронизации**: Переход на event-driven модель вместо polling
- **Схема БД**: Добавлена таблица order_events с соответствующими связями

### Исправлено
- Устранены неопределенности в архитектурных вопросах
- Определены точные API ограничения и требования

## [1.0.0] - 2024-01-15

### Добавлено
- **Инициализация проекта**: Создана структура документации для микросервиса интеграции с Allegro API
- **project.md**: Детальное описание архитектуры, целей и технологического стека
- **tasktracker.md**: Система отслеживания задач с приоритизацией и этапами разработки
- **diary.md**: Дневник разработки для документирования технических решений и наблюдений
- **qa.md**: Список критических вопросов по архитектуре, требующих уточнения
- **changelog.md**: Система отслеживания изменений в проекте

#### Архитектурные решения:
- **Идентификация пользователей**: Механизм через внешний user_id без собственной авторизации
- **Схема БД**: Три основные таблицы (user_tokens, orders, sync_history) с UUID ключами
- **Стратегия синхронизации**: Incremental синхронизация с timestamp tracking
- **Технологический стек**: FastAPI + SQLModel + Celery + PostgreSQL + Redis
- **Инфраструктура**: Docker Compose с полной контейнеризацией

#### API Эндпоинты (планируемые):
- Управление токенами: `/api/v1/tokens/`
- Синхронизация: `/api/v1/sync/`
- Заказы: `/api/v1/orders/`
- Мониторинг: `/health`, `/metrics`

#### Celery задачи (планируемые):
- `refresh_all_tokens()` - автоматический рефреш токенов
- `sync_all_orders()` - массовая синхронизация заказов
- `cleanup_old_sync_history()` - очистка старых записей

### Технические характеристики:
- **Производительность**: API < 200ms, синхронизация 1000 заказов < 5 минут
- **Надежность**: Uptime > 99.9%, автоматическое восстановление
- **Безопасность**: Шифрование токенов, валидация данных, аудит логи
- **Логирование**: JSON формат, ротация 5MB/3 файла

### Этапы разработки:
1. **Базовая инфраструктура** (Критический)
2. **Allegro API интеграция** (Критический)  
3. **Синхронизация заказов** (Высокий)
4. **Celery интеграция** (Высокий)
5. **Продвинутые функции** (Средний)
6. **Тестирование и документация** (Средний)

### Изменено
- Отсутствует

### Исправлено
- Отсутствует

---

## Шаблон для будущих записей

```markdown
## [Версия] - YYYY-MM-DD

### Добавлено
- Новые функции
- Новые API эндпоинты
- Новые конфигурационные параметры
- Новые зависимости

### Изменено
- Изменения в существующих функциях
- Изменения в API
- Изменения в конфигурации
- Обновления зависимостей

### Исправлено
- Исправленные баги
- Улучшения производительности
- Исправления безопасности
```

---

**Формат**: Следует [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/)  
**Версионирование**: [Semantic Versioning](https://semver.org/lang/ru/)  
**Инициализация**: 2024-01-15 

## [2025-01-13] - Завершение Device Code Flow авторизации

### Исправлено
- **Критическая ошибка в Celery задаче**: Исправлена неправильная обработка retry исключений в `poll_authorization_status`
- Заменен `except self.retry.__class__` на правильный `except Retry` с импортом `from celery.exceptions import Retry`
- Устранена ошибка `TypeError: catching classes that do not inherit from BaseException is not allowed`

### Завершено
- **Device Code Flow авторизация полностью функциональна**: Все компоненты работают корректно
- Отладочные логи показывают каждый этап процесса авторизации
- Система корректно обрабатывает все статусы: pending, completed, failed, expired
- Celery polling работает стабильно с retry логикой
- API эндпоинты для авторизации готовы к продакшену

### Готово к следующему этапу
- Инфраструктура настроена и стабильна
- API токенов полностью протестирован
- Device Code Flow авторизация реализована и отлажена
- Система готова к реализации синхронизации заказов

## [2025-01-13] - Удаление отладочных логов

### Изменено
- Удалены debug логи [DEBUG] из большинства компонентов системы для улучшения производительности
- В app/services/token_service.py убраны все debug логи, оставлено только основное логирование
- В app/api/v1/tokens.py убраны debug логи из стандартных CRUD эндпоинтов (create, get, update, delete, refresh, validate)
- В app/services/allegro_auth_service.py убраны debug логи из методов refresh_token, validate_token, check_and_refresh_token

### Оставлено для отладки Device Code Flow
- Debug логи сохранены в app/tasks/token_tasks.py для всех Celery задач (особенно poll_authorization_status)
- Debug логи сохранены в Device Code Flow эндпоинтах: initialize_auth, check_auth_status, get_auth_task_status
- Debug логи сохранены в AllegroAuthService методах: initialize_device_flow, check_auth_status

### Добавлено
- Исправлено создание токена с автоматической деактивацией старых токенов пользователя
- Улучшена обработка ошибок и логирование в сервисах

### Исправлено
- Устранены проблемы совместимости Pydantic v2 с SQLModel через изменение validate_assignment = False
- Исправлены SQL UPDATE запросы для избежания конфликтов Pydantic v2
- Улучшена стабильность API эндпоинтов

## [2025-01-13] - Отладка и тестирование API токенов с подробным логированием

### Добавлено
- Подробное debug логирование во все API эндпоинты для работы с токенами
- Debug логи в TokenService для всех операций с базой данных
- Debug логи в AllegroAuthService для всех HTTP запросов к Allegro API
- Debug логи в Celery задачах для отслеживания polling процесса
- Детализированное логирование ошибок и исключений

### Исправлено
- Критическая ошибка Pydantic v2 совместимости: изменен validate_assignment с True на False в BaseModel
- Исправлен UPDATE эндпоинт для токенов с использованием SQL UPDATE вместо изменения полей объекта
- Исправлен DELETE эндпоинт с корректной деактивацией токенов
- Устранены дублирования Celery задач через уникальные task_id

### Проверено
- Все API эндпоинты протестированы и работают корректно
- PostgreSQL соединение стабильно
- Celery worker и beat функционируют без ошибок
- Health check эндпоинт работает

## [2025-01-13] - Реализация Device Code Flow авторизации

### Добавлено
- AllegroAuthService с полной поддержкой Device Code Flow
- API эндпоинты для инициализации и проверки статуса авторизации  
- Celery задачи для автоматического polling статуса авторизации
- Автоматическое создание токенов при успешной авторизации
- Retry логика с экспоненциальной задержкой
- Rate limiting для предотвращения spam запросов

### Изменено
- Обновлена архитектура проекта с добавлением Mermaid диаграммы
- Расширена документация по Device Code Flow процессу
- Улучшена обработка ошибок авторизации

### Исправлено  
- Ошибки FastAPI endpoints с корректными типами ответов
- Проблемы с асинхронными HTTP запросами через httpx
- Совместимость Pydantic моделей с SQLModel 