# Allegro Orders Backup - –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

**Allegro Orders Backup** - —ç—Ç–æ –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Allegro API, –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## üéØ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞

### ‚úÖ –≠–¢–ê–ü 1: Device Code Flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è - –ó–ê–í–ï–†–®–ï–ù
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: 100%
- **–°—Ç–∞—Ç—É—Å**: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: AllegroAuthService, API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, Celery polling, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

### üöÄ –≠–¢–ê–ü 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ - –í –†–ê–ó–†–ê–ë–û–¢–ö–ï  
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: 0%
- **–§–æ–∫—É—Å**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è event-driven —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Allegro API
- **–¶–µ–ª—å**: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

## –¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏
- –í—ã–Ω–µ—Å–µ–Ω–∏–µ –≤—Å–µ–π –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å Allegro API –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ–ª–∏—Ç–∏–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Allegro
- –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ Device Code Flow
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Ñ—Ä–µ—à —Ç–æ–∫–µ–Ω–æ–≤
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ cron-—Ä–µ–∂–∏–º–µ
- –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–∫–∞–∑–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞–º–æ–∫
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```mermaid
graph TB
    A[FastAPI Application] --> B[Token Manager]
    A --> C[Order Sync Service]
    A --> D[Allegro API Client]
    
    B --> E[PostgreSQL Database]
    C --> E
    
    F[Celery Beat] --> G[Celery Worker]
    G --> C
    G --> B
    
    H[Redis] --> F
    H --> G
    
    D --> I[Allegro API]
```

### –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
-- –¢–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE user_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id VARCHAR(255) NOT NULL,
    allegro_token TEXT NOT NULL,
    refresh_token TEXT NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE(user_id)
);

-- –ó–∞–∫–∞–∑—ã
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_token_id UUID REFERENCES user_tokens(id) ON DELETE CASCADE,
    allegro_order_id VARCHAR(255) NOT NULL,
    order_data JSONB NOT NULL,
    order_date TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_deleted BOOLEAN DEFAULT FALSE,
    UNIQUE(user_token_id, allegro_order_id)
);

-- –ò—Å—Ç–æ—Ä–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
CREATE TABLE sync_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_token_id UUID REFERENCES user_tokens(id) ON DELETE CASCADE,
    sync_started_at TIMESTAMP WITH TIME ZONE NOT NULL,
    sync_completed_at TIMESTAMP WITH TIME ZONE,
    sync_status VARCHAR(50) NOT NULL, -- 'running', 'completed', 'failed'
    orders_processed INTEGER DEFAULT 0,
    orders_added INTEGER DEFAULT 0,
    orders_updated INTEGER DEFAULT 0,
    error_message TEXT,
    sync_from_date TIMESTAMP WITH TIME ZONE,
    sync_to_date TIMESTAMP WITH TIME ZONE
);

-- –°–æ–±—ã—Ç–∏—è –∑–∞–∫–∞–∑–æ–≤ (–Ω–∞ –æ—Å–Ω–æ–≤–µ Allegro API events)
CREATE TABLE order_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_id VARCHAR(255) NOT NULL,
    token_id UUID NOT NULL REFERENCES user_tokens(id) ON DELETE CASCADE,
    event_type VARCHAR(100) NOT NULL, -- ORDER_STATUS_CHANGED, PAYMENT_STATUS_CHANGED, etc.
    occurred_at TIMESTAMP WITH TIME ZONE NOT NULL,
    event_data JSONB NOT NULL,
    processed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(order_id, occurred_at, event_type)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_orders_token_created ON orders(token_id, created_at);
CREATE INDEX idx_orders_status ON orders USING gin((order_data->>'status'));
CREATE INDEX idx_order_events_occurred ON order_events(occurred_at);
CREATE INDEX idx_sync_history_token_timestamp ON sync_history(token_id, sync_timestamp);
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Celery –æ—á–µ—Ä–µ–¥–µ–π –ø–æ —Ç–æ–∫–µ–Ω—É

- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å Celery (sync_{token_id})
- –ó–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å
- –í–æ—Ä–∫–µ—Ä—ã Celery –º–∞—Å—à—Ç–∞–±–∏—Ä—É—é—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –∏ –º–æ–≥—É—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥–µ–π
- –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–∞—á —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ task_history (Postgres)
- API –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á –ø–æ —Ç–æ–∫–µ–Ω—É –∏ task_id

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```mermaid
flowchart TD
    User -- API: start sync --> FastAPI
    FastAPI -- .apply_async(queue=sync_{token_id}) --> Celery
    Celery -- task_id, status --> Postgres[(task_history)]
    FastAPI -- API: status/stop/list --> Postgres
    FastAPI -- revoke(task_id) --> Celery
    Celery -- –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å --> Postgres
    Celery -. –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è .-> Celery
```

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í docker-compose –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤, –∫–∞–∂–¥—ã–π –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥–µ–π
- –î–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å autoscaling (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Kubernetes)
- –û—á–µ—Ä–µ–¥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ –º–µ—Ä–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

### Best practices
- –î–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ –æ—á–µ—Ä–µ–¥–∏ –º–æ–∂–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ –ø–æ —Ö–µ—à—É —Ç–æ–∫–µ–Ω–∞)
- –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É task_history –∏ Celery Flower

## Allegro API Integration

### Device Code Flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ Allegro API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Device Code Flow - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ –±—Ä–∞—É–∑–µ—Ä–∞. –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Celery –∑–∞–¥–∞—á–∏.

```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant API as FastAPI App
    participant Allegro as Allegro API
    participant Celery as Celery Worker
    participant DB as –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

    User->>API: POST /auth/initialize {user_id}
    API->>Allegro: –ó–∞–ø—Ä–æ—Å device_code –∏ user_code
    Allegro->>API: device_code, user_code, verification_uri, expires_in
    
    API->>Celery: –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ poll_authorization_status
    Celery->>API: task_id
    
    API->>User: –ö–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ + task_id + —Å—Å—ã–ª–∫–∞
    
    Note over User: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ<br/>–∏ –≤–≤–æ–¥–∏—Ç user_code –≤ Allegro
    
    User->>Allegro: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å user_code
    Allegro->>User: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    
    loop –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π polling (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫, –º–∞–∫—Å 30 –ø–æ–ø—ã—Ç–æ–∫)
        Celery->>Allegro: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å device_code
        alt –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            Allegro->>Celery: status: pending
            Note over Celery: –û–∂–∏–¥–∞–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥
        else –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            Allegro->>Celery: access_token + refresh_token
            Celery->>DB: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ UserToken
            DB->>Celery: –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω
            Note over Celery: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ SUCCESS
        end
    end
    
    opt –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
        User->>API: GET /auth/task/{task_id}
        API->>Celery: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
        Celery->>API: PENDING/SUCCESS/FAILURE + —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        API->>User: –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    end
    
    opt –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        User->>API: GET /user/{user_id} (–ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã)
        API->>DB: –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        DB->>API: –°–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤
        API->>User: –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
    end
```

### –ö–ª—é—á–µ–≤—ã–µ API endpoints

**GET /order/events**:
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: Event-driven —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–∫–∞–∑–æ–≤
- **Rate limit**: 60 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: `from` (RFC3339), `limit` (max 1000), `type[]`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ó–∞–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 2-3 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π

**GET /order/checkout-forms**:
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Rate limit**: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: `offset`, `limit`, `status`, `createdAt.gte/lte`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ initial load

**GET /order/checkout-forms/{id}**:
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
- **Rate limit**: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏–π

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**Event-driven –ø–æ–¥—Ö–æ–¥**:
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π**: –†–µ–≥—É–ª—è—Ä–Ω—ã–π –æ–ø—Ä–æ—Å GET /order/events
2. **–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π**:
   - ORDER_STATUS_CHANGED - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
   - PAYMENT_STATUS_CHANGED - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
   - DELIVERY_INFO_CHANGED - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏
   - ORDER_CANCELLED - –æ—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞

3. **–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–∞–±–æ—Ç–∫–∏**:
   ```python
   # –ü—Å–µ–≤–¥–æ–∫–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   last_sync = get_last_sync_timestamp(token_id)
   events = allegro_client.get_order_events(from=last_sync)
   
   for event in events:
       if event.type in TRACKED_EVENTS:
           order_data = allegro_client.get_order_details(event.order.id)
           upsert_order(token_id, event.order.id, order_data)
           save_order_event(event)
   
   update_sync_timestamp(token_id, now())
   ```

### Rate Limiting –∏ Error Handling

**Rate Limits**:
- –û–±—â–∏–µ API: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É  
- Orders API: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- Events API: 60 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- Device Code Flow: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ retry**:
- 429 Too Many Requests: exponential backoff + Retry-After header
- 5xx errors: exponential backoff (–º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏)
- Network timeouts: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π retry
- 401 Unauthorized: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh —Ç–æ–∫–µ–Ω–∞

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–∏–º–∏—Ç–æ–≤**:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ X-RateLimit-Remaining header
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ Celery rate limiting
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö 429 –æ—Ç–≤–µ—Ç–æ–≤

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend Framework
- **FastAPI** - –æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **SQLModel** - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- **Pydantic v2** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **PostgreSQL** - –æ—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Alembic** - –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- **Celery** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- **Celery Beat** - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- **Redis** - –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è Celery

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **Docker Compose** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- **Poetry** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- **python-dotenv** - –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- **httpx** - HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è Allegro API
- **python-multipart** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ multipart –¥–∞–Ω–Ω—ã—Ö
- **uvicorn** - ASGI —Å–µ—Ä–≤–µ—Ä

## API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
```
# –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–æ–∫–µ–Ω–∞–º–∏
POST /api/v1/tokens/                    # –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω
GET /api/v1/tokens/                     # –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤
GET /api/v1/tokens/{token_id}           # –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–æ ID
PUT /api/v1/tokens/{token_id}           # –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
DELETE /api/v1/tokens/{token_id}        # –£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å)
GET /api/v1/tokens/user/{user_id}       # –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /api/v1/tokens/{token_id}/refresh  # –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ refresh_token
POST /api/v1/tokens/{token_id}/validate # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω

# Device Code Flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
POST /api/v1/tokens/auth/initialize     # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
GET /api/v1/tokens/auth/status/{device_code} # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
GET /api/v1/tokens/auth/task/{task_id}  # –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```
POST /api/v1/sync/manual/{user_id}      # –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
GET /api/v1/sync/status/{user_id}       # –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
GET /api/v1/sync/history/{user_id}      # –ò—Å—Ç–æ—Ä–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```

### –ó–∞–∫–∞–∑—ã
```
GET /api/v1/orders/{user_id}            # –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET /api/v1/orders/{user_id}/{order_id} # –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–∫–∞–∑
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```
GET /health                             # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
GET /metrics                            # –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

## Celery –∑–∞–¥–∞—á–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
- `refresh_all_tokens()` - —Ä–µ—Ñ—Ä–µ—à –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)
- `sync_order_events()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ GET /order/events (–∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã)
- `full_sync_all_orders()` - –ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
- `cleanup_old_sync_history()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
- `cleanup_old_order_events()` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π –∑–∞–∫–∞–∑–æ–≤ (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ)

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `poll_authorization_status(device_code, user_id, expires_at_iso, interval_seconds)` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π polling –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Device Code Flow (—Ä–∞–∑–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞ –∫–∞–∂–¥—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)

### Event-driven –∑–∞–¥–∞—á–∏
- `process_order_events(token_id)` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
- `update_order_from_event(token_id, event_data)` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏—è
- `sync_missing_orders(token_id, order_ids)` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤

### –†—É—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
- `sync_user_orders(user_id, from_date=None)` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `full_resync_user_orders(user_id)` - –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- `manual_process_events(user_id, from_date=None)` - —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/allegro_backup
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=allegro_backup
DATABASE_USER=user
DATABASE_PASSWORD=password

# Redis
REDIS_URL=redis://localhost:6379/0
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# FastAPI
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=False
LOG_LEVEL=INFO

# Celery
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0

# Allegro API
ALLEGRO_CLIENT_ID=your_client_id
ALLEGRO_CLIENT_SECRET=your_client_secret
ALLEGRO_API_URL=https://api.allegro.pl

# Logging
LOG_FILE_PATH=./logs/app.log
LOG_MAX_BYTES=5242880  # 5MB
LOG_BACKUP_COUNT=3
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **–§–æ—Ä–º–∞—Ç**: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- **–†–æ—Ç–∞—Ü–∏—è**: –ú–∞–∫—Å–∏–º—É–º 5MB –Ω–∞ —Ñ–∞–π–ª, –Ω–µ –±–æ–ª–µ–µ 3 —Ñ–∞–π–ª–æ–≤
- **–£—Ä–æ–≤–Ω–∏**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **–í—ã—Ö–æ–¥—ã**: –§–∞–π–ª –∏ stdout (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è)

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥-–∑–∞–ø–∏—Å–∏
```json
{
    "timestamp": "2024-01-15T10:30:00Z",
    "level": "INFO",
    "logger": "allegro_backup.services.sync",
    "message": "Starting order sync for user",
    "user_id": "user123",
    "correlation_id": "uuid",
    "extra": {}
}
```

## –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
- **SOLID** - —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
- **DRY** - –∏–∑–±–µ–∂–∞–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- **KISS** - –ø—Ä–æ—Å—Ç–æ—Ç–∞ –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π
- **Clean Architecture** - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **Repository Pattern** - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
- **Service Layer** - –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- **Factory Pattern** - –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ API
- **Observer Pattern** - –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–æ–±—ã—Ç–∏—è—Ö

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ refresh —Ç–æ–∫–µ–Ω–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### API –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- Rate limiting –¥–ª—è API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### Health Checks
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Allegro API

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å API
- –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è

## –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ (periodic tasks)

- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ API (POST /sync/activate)
- –î–ª—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è celery-sqlalchemy-scheduler (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Postgres)
- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚Äî —á–µ—Ä–µ–∑ API (POST /sync/deactivate)
- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ API (GET /sync/active)
- –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ active_sync_schedules (user_id, token_id, interval, —Å—Ç–∞—Ç—É—Å, last_run, last_success, ...)
- –î–ª—è —Ä–∞–±–æ—Ç—ã —Å celery-sqlalchemy-scheduler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è get_alchemy_session
- Best practices: –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ task_name –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞, —Ö—Ä–∞–Ω–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ë–î

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Docker Compose
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "${API_PORT}:${API_PORT}"
    depends_on:
      - db
      - redis
    env_file:
      - .env

  worker:
    build: .
    command: celery -A app.celery worker -l info
    depends_on:
      - db
      - redis
    env_file:
      - .env

  beat:
    build: .
    command: celery -A app.celery beat -l info
    depends_on:
      - db
      - redis
    env_file:
      - .env

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT}:6379"

volumes:
  postgres_data:
```

## –≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å Poetry
- –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π SQLModel
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è
- –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 2: Allegro API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π) ‚úÖ 90% –ó–ê–í–ï–†–®–ï–ù–û
- ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Device Code Flow —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º polling
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è Allegro API (httpx)
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –∏—Ö —Ä–µ—Ñ—Ä–µ—à
- ‚úÖ –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Celery
- ‚úÖ AllegroAuthService –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

### –≠—Ç–∞–ø 3: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ (–í—ã—Å–æ–∫–∏–π)
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Allegro API
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –≤ –ë–î
- –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### –≠—Ç–∞–ø 4: Celery –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–í—ã—Å–æ–∫–∏–π)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Celery –∏ Redis
- –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á —Å Celery Beat
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á

### –≠—Ç–∞–ø 5: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–°—Ä–µ–¥–Ω–∏–π)
- Incremental —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- –î–µ—Ç–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–°—Ä–µ–¥–Ω–∏–π)
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Integration —Ç–µ—Å—Ç—ã
- API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞—á–µ—Å—Ç–≤—É

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API: < 200ms –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: > 100 RPS
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- Uptime: 99.9%
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
- Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Celery workers
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ä–∞—Å—Ç—É—â–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.1  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2024-01-15  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2024-01-21  
**–ê–≤—Ç–æ—Ä**: System Architect  
**–°—Ç–∞—Ç—É—Å**: –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - Device Code Flow —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω 