# Дневник разработки - Allegro Orders Backup

## 2024-01-15

### Наблюдения
- Инициализация проекта микросервиса интеграции с Allegro API
- Проведен глубокий анализ требований к системе
- Определена архитектура микросервиса с четким разделением ответственности
- Выбрана стратегия идентификации пользователей через внешний user_id
- Спроектирована схема базы данных с учетом изоляции данных по токенам

### Технические решения

#### 1. Механизм идентификации пользователей
**Решение**: Использование внешнего `user_id` (строка/UUID) вместо собственной системы авторизации
**Обоснование**: 
- Простота интеграции с существующими системами
- Отсутствие необходимости управлять пользователями
- Четкая изоляция данных
- Масштабируемость решения

#### 2. Архитектура базы данных
**Решение**: Три основные таблицы - `user_tokens`, `orders`, `sync_history`
**Обоснование**:
- `user_tokens` - изоляция токенов по пользователям
- `orders` - хранение заказов с привязкой к токенам
- `sync_history` - отслеживание процессов синхронизации
- Использование UUID для первичных ключей обеспечивает уникальность
- JSONB для order_data обеспечивает гибкость структуры заказов

#### 3. Стратегия синхронизации
**Решение**: Incremental синхронизация с timestamp tracking
**Обоснование**:
- Эффективность - синхронизируем только новые/измененные заказы
- Надежность - сохраняем timestamp последней успешной синхронизации
- Восстановимость - возможность пересинхронизации с любого момента
- Защита от потери данных при очистке данных в Allegro

#### 4. Технологический стек
**Решение**: FastAPI + SQLModel + Celery + PostgreSQL + Redis
**Обоснование**:
- FastAPI - современный, быстрый, с автоматической документацией
- SQLModel - типизированная ORM с Pydantic валидацией
- Celery - надежная обработка фоновых задач
- PostgreSQL - надежная СУБД с поддержкой JSONB
- Redis - быстрый брокер для Celery

### Решения
- Создана структура документации проекта
- Определены этапы разработки с четкими критериями готовности
- Спланирована архитектура с учетом требований надежности и масштабируемости
- Выбраны технологии в соответствии с best practices

### Проблемы
- Необходимо изучить детали Allegro API для Device Code Flow
- Требуется проработка rate limiting стратегии для API запросов
- Нужно определить оптимальные интервалы для автоматической синхронизации

---

## Шаблон для будущих записей

### 2024-XX-XX

### Наблюдения
- [Описание того, что наблюдалось в процессе разработки]
- [Новые инсайты или понимание системы]
- [Поведение системы в различных условиях]

### Технические решения
#### [Название решения]
**Решение**: [Краткое описание принятого решения]
**Обоснование**: [Почему выбрано именно это решение]
**Альтернативы**: [Какие еще варианты рассматривались]
**Влияние**: [Как это влияет на архитектуру/производительность]

### Решения
- [Конкретные действия, предпринятые за день]
- [Завершенные задачи]
- [Принятые технические решения]

### Проблемы
- [Выявленные проблемы]
- [Технические сложности]
- [Неопределенности, требующие дальнейшего исследования]

---

## Важные технические заметки

### Allegro API Ограничения
- Rate limiting: [Будет определено после изучения документации]
- Формат данных заказов: [Будет определено после исследования]
- Особенности Device Code Flow: [Требует изучения]

### Производительность
- Целевые метрики: API < 200ms, синхронизация 1000 заказов < 5 минут
- Стратегия оптимизации: batch обработка, connection pooling, кэширование

### Безопасность
- Шифрование токенов в базе данных (планируется)
- Валидация всех входящих данных
- Логирование всех операций с токенами

### Мониторинг
- Структурированные логи в JSON формате
- Метрики производительности через health checks
- Алерты на критические ошибки синхронизации

---

**Инициализация дневника**: 2024-01-15  
**Автор**: System Architect  
**Следующая запись**: После завершения этапа 1 